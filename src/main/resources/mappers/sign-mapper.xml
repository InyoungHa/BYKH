<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<mapper namespace="signMapper">

	
	<!--연차신청서 테이블  -->
	<resultMap type="com.bykh.groupware.sign.vo.DocAnnualLeaveVO" id="docAnnualLeave">
		<id column="DAL_NO" 				property="dalNo"/>
		<result column="DOC_NO" 			property="docNo"/>
		<result column="DAL_TYPE" 			property="dalType"/>
		<result column="START_DATE" 		property="startDate"/>
		<result column="END_DATE" 			property="endDate"/>
		<result column="START_TIME" 		property="startTime"/>
		<result column="END_TIME" 			property="endTime"/>
		<result column="LEAVE_DAYS" 		property="leaveDays"/>
		<result column="LEAVE_REASON" 		property="leaveReason"/>
	</resultMap>
	
	<!-- 구매신청서 테이블 -->
	<resultMap type="com.bykh.groupware.sign.vo.DocPurchaseOrderVO" id="docPurchaseOrder">
		<id column="DPO_NO" 				property="dpoNo" />
		<result column="DOC_NO" 			property="docNo" />
		<result column="DPO_COMMENT" 		property="dpoComment" />
		<result column="BUY_NO" 			property="buyNo" />
		<association property="buyVO" resultMap="buy"></association>
	</resultMap>
	
	<!--결재문서 테이블  -->
	<resultMap type="com.bykh.groupware.sign.vo.SignDocVO" id="signDoc">
		<id column="DOC_NO" 				property="docNo"/>
		<result column="DOC_TYPE" 				property="docType"/>
		<result column="WRITER_NO" 			property="writerNo"/>
		<result column="DOC_TITLE" 			property="docTitle"/>
		<result column="SGN_STATUS" 		property="sgnStatus"/>
		<result column="SGN_STATUS_STR" 	property="sgnStatusStr"/>
		<result column="INSERT_DATE" 		property="insertDate"/>
		<association property="empVO" 		resultMap="empMapper.emp"></association>
		<association property="docAnnualLeaveVO" 		resultMap="docAnnualLeave"></association>
		<association property="docPurchaseOrderVO" 		resultMap="docPurchaseOrder"></association>
		<collection property="signVOList" resultMap="sign" column="DOC_NO"></collection>
	</resultMap>
	
	
	<!--결재 테이블 -->
	<resultMap type="com.bykh.groupware.sign.vo.SignVO" id="sign">
		<id column="DOC_NO" 				property="docNo"/>
		<id column="SGN_ORDER"				property="sgnOrder"/>
		<result column="SGN_RESULT"			property="sgnResult"/>
		<result column="SGN_RESULT_STR"		property="sgnResultStr"/>
		<result column="APPROVER_NO" 		property="approverNo"/>
		<result column="APPROVER_NAME" 		property="approverName"/>
		<result column="APPROVER_JOB" 		property="approverJob"/>
		<result column="SGN_COMENT" 		property="sgnComent"/>
		<result column="SGN_DATE" 			property="sgnDate"/>
	</resultMap>
	
	<!-- 아이템 테이블 -->
	<resultMap type="com.bykh.groupware.sign.vo.ItemVO" id="item">
		<id column="ITEM_NO"				property="itemNo"/>
		<result column="ITEM_NAME"			property="itemName"/>
		<result column="ITEM_PRICE"			property="itemPrice"/>
		<result column="REG_DATE" 			property="regDate"/>
	</resultMap>
	
	<!-- 구매 테이블 -->
	<resultMap type="com.bykh.groupware.sign.vo.BuyVO" id="buy">
		<id column="BUY_NO"					property="buyNo"/>
		<result column="BUY_DEPTNO"			property="buyDeptNo"/>
		<result column="BUY_PRICE"			property="buyPrice"/>
		<result column="BUY_APPROVAL" 		property="buyApproval"/>
		<collection property="buyDetailVOList" resultMap="buyDetail"></collection>
	</resultMap>
	
	<!-- 구매상세 테이블 -->
	<resultMap type="com.bykh.groupware.sign.vo.BuyDetailVO" id="buyDetail">
		<id column="BUY_DETAIL_NO"			property="buyDetailNo"/>
		<result column="BUY_NO"				property="buyNo"/>
		<result column="ITEM_NO"			property="itemNo"/>
		<result column="BUY_CNT" 			property="buyCnt"/>
		<result column="BUY_DETAIL_PRICE" 	property="buyDetailPrice"/>
		<association property="itemVO" resultMap="item"></association>
	</resultMap>
	
	
	<!-- 기안 조회 페이지 -->
	<select id="getInProgressSignDocList" resultMap="signDoc">
		SELECT 
		    DOC_NO
		    , DOC_TYPE
		    , DOC_TITLE
		    , ENAME
		    , TO_CHAR(INSERT_DATE, 'YYYY-MM-DD HH24:MI') INSERT_DATE
		    , DECODE(SGN_STATUS, 0, '임시저장', 1, '결재중') AS SGN_STATUS_STR
		FROM SGN_DOC SD,EMP
		WHERE SD.WRITER_NO = EMP.EMPNO
		AND SGN_STATUS IN (0, 1)
		AND (
                (SGN_STATUS = 0 AND SD.WRITER_NO = ${empno}) 
            OR 
                (SGN_STATUS = 1 AND SD.WRITER_NO = ${empno})
            OR
                (SGN_STATUS = 1 AND EXISTS (SELECT 1 FROM SGN WHERE SD.DOC_NO = SGN.DOC_NO AND APPROVER_NO = ${empno}))
            )
		ORDER BY INSERT_DATE DESC
	</select>
	<select id="getEndSignDocList" resultMap="signDoc">
		SELECT 
		    DOC_NO
		    , DOC_TYPE
		    , DOC_TITLE
		    , ENAME
		    , TO_CHAR(INSERT_DATE, 'YYYY-MM-DD HH24:MI') INSERT_DATE
		    , DECODE(SGN_STATUS, 2, '결재완료', 3, '반려') AS SGN_STATUS_STR
		FROM SGN_DOC SD,EMP
		WHERE SD.WRITER_NO = EMP.EMPNO
		AND SGN_STATUS IN (2, 3)
		AND (
				(SD.WRITER_NO = ${empno})
			OR
				(EXISTS (SELECT 1 FROM SGN WHERE SD.DOC_NO = SGN.DOC_NO AND APPROVER_NO = ${empno}))
			)
		ORDER BY INSERT_DATE DESC
	</select>
	<!-- 기안 작성 페이지 이동 시 회원정보 가져가기 -->
	<select id="getSingWriteInfo" resultMap="signDoc">
		SELECT 
			ENAME
			, DENAME 
			, EMPNO
			, D.DEPTNO
            , (SELECT ENAME FROM EMP WHERE EMP.DEPTNO = D.DEPTNO AND E_JOB = '과장') AS APPROVER_NAME
            , (SELECT EMPNO FROM EMP WHERE EMP.DEPTNO = D.DEPTNO AND E_JOB = '과장') AS APPROVER_NO
            , (SELECT E_JOB FROM EMP WHERE EMP.DEPTNO = D.DEPTNO AND E_JOB = '과장') AS APPROVER_JOB
		FROM EMP E, DEPT D
		WHERE E.DEPTNO = D.DEPTNO
		AND EMPNO = ${empno}
	</select>
	
	<!-- 결재자 지정 - 전체 사원 조회 -->
	<select id="getEmpList" resultMap="empMapper.emp">
		SELECT 
			EMPNO
			, ENAME
			, E_JOB
		FROM EMP
		WHERE ENAME LIKE '%'||#{ename}||'%'
		ORDER BY DEPTNO
	</select>
	
	<!-- 다음에 문서번호 조회(결재문서 테이블) -->
	<select id="getNextDocNo" resultType="int">
		SELECT NVL(MAX(DOC_NO), 0) + 1 FROM SGN_DOC
	</select>
	
	<!-- 기안 INSERT -->
	<insert id="insertSignDoc">
		INSERT INTO SGN_DOC (
		    DOC_NO
		    , DOC_TYPE
		    , WRITER_NO
		    , DOC_TITLE
		    , SGN_STATUS
		) VALUES (
		    (SELECT NVL(MAX(DOC_NO), 0) + 1 FROM SGN_DOC)
		    , ${docType}
		    , ${writerNo}
		    , #{docTitle}
		    , ${sgnStatus}
		) 
	</insert>
	<!-- 연차신청서 insert -->
	<insert id="insertDocAnnualLeave">
		INSERT INTO DOC_ANNUAL_LEAVE (
		    DAL_NO
		    , DOC_NO
		    , DAL_TYPE
		    , START_DATE
		    , END_DATE
		<if test="docAnnualLeaveVO.startTime != null and docAnnualLeaveVO.endTime != null">
		    , START_TIME
		    , END_TIME
		</if>
		    , LEAVE_DAYS
		    , LEAVE_REASON
		) VALUES(
		    (SELECT NVL(MAX(DAL_NO), 0) + 1 FROM DOC_ANNUAL_LEAVE)
		    , ${docAnnualLeaveVO.docNo}
		    , #{docAnnualLeaveVO.dalType}
		    , #{docAnnualLeaveVO.startDate}
		    , #{docAnnualLeaveVO.endDate}
		<if test="docAnnualLeaveVO.startTime != null and docAnnualLeaveVO.endTime != null">
		    , ${docAnnualLeaveVO.startTime}
		    , ${docAnnualLeaveVO.endTime}		
		</if>
		    , ${docAnnualLeaveVO.leaveDays}
		    , #{docAnnualLeaveVO.leaveReason}
		)
	</insert>
	<!-- 결재문서 insert -->
	<insert id="insertDocPurchaseOrder">
		INSERT INTO DOC_PURCHASE_ORDER (
		    DPO_NO
		    , DOC_NO
		    , DPO_COMMENT
		    , BUY_NO
		) VALUES(
		    (SELECT NVL(MAX(DPO_NO), 0)+1 FROM DOC_PURCHASE_ORDER)
		    , ${docNo}
		    , #{dpoComment}
		    , ${buyNo}
		)
	</insert>
	
	<!-- 다음 BuyNo 조회 -->
	<select id="getNextBuyNo" resultType="int">
		SELECT NVL(MAX(BUY_NO), 0)+1 FROM BUY
	</select>
	
	<!-- buy 테이블 insert -->
	<insert id="insertBuy">
		INSERT INTO BUY (
		    BUY_NO
		    , BUY_DEPTNO
		    , BUY_PRICE
		    , BUY_APPROVAL
		) VALUES(
		    ${buyNo}
		    , ${buyDeptNo}
		    , ${buyPrice}
		    , 0
		)
	</insert>
	<!-- buyDetail 테이블 insert -->
	<insert id="insertBuyDetails">
		INSERT ALL
		<foreach collection="buyDetailVOList" item="buyDetail" index="i">
			 INTO BUY_DETAIL (
		        BUY_DETAIL_NO
		        , BUY_NO
		        , ITEM_NO
		        , BUY_CNT
		        , BUY_DETAIL_PRICE
		    ) VALUES(
		        (SELECT NVL(MAX(BUY_DETAIL_NO), 0) + ${i+1} FROM BUY_DETAIL)
		        , ${buyDetailVOList[0].buyNo}
		        , ${buyDetail.itemNo}
		        , ${buyDetail.buyCnt}
		        , ${buyDetail.buyDetailPrice}
		    )
		</foreach>
		SELECT 1 FROM DUAL
	</insert>
	<!-- 결재리스트 추가 -->
	<insert id="insertSignList">
		INSERT ALL
		<foreach collection="signVOList" item="sign" index="i">
			INTO SGN (
			    DOC_NO
			    , SGN_ORDER
			    , APPROVER_NO
			) VALUES(
			    ${signVOList[0].docNo}
			    , ${i+1}
			    , ${sign.approverNo}
			)
		</foreach>
		SELECT 1 FROM DUAL
	</insert>
	
	<!-- 결재문서 상세조회 - 연차신청서 -->
	<select id="getDetailDocAnnualLeave" resultMap="signDoc">
		SELECT 
		    DOC.DOC_NO
		    , WRITER_NO
		    , DOC_TITLE
            , TO_CHAR(INSERT_DATE, 'YYYY-MM-DD') INSERT_DATE
		    , DAL_NO
		    , DAL_TYPE
		    , TO_CHAR(START_DATE, 'YYYY-MM-DD') START_DATE
		    , TO_CHAR(END_DATE, 'YYYY-MM-DD') END_DATE
		    , START_TIME
		    , END_TIME
		    , LEAVE_DAYS
		    , LEAVE_REASON
            , ENAME
            , DENAME
            , APPROVER_NO
            , (SELECT ENAME FROM EMP WHERE EMPNO = SGN.APPROVER_NO) APPROVER_NAME
            , (SELECT E_JOB FROM EMP WHERE EMPNO = SGN.APPROVER_NO) APPROVER_JOB
            , SGN_ORDER
            , DECODE(SGN_RESULT, '0', '미결재', '1', '결재') SGN_RESULT_STR
            , SGN_COMENT
            , TO_CHAR(SGN_DATE, 'YYYY-MM-DD')SGN_DATE
		FROM SGN_DOC DOC, DOC_ANNUAL_LEAVE DAL, SGN, EMP, DEPT
		WHERE DOC.DOC_NO = DAL.DOC_NO
        AND SGN.DOC_NO = DOC.DOC_NO
        AND DOC.WRITER_NO = EMP.EMPNO
        AND EMP.DEPTNO = DEPT.DEPTNO
		AND DOC.DOC_NO = ${docNo}
	</select>
	<!-- '결재' / '반려' 버튼 클릭 시 실행 -->
	<update id="updateSignResult">
		UPDATE SGN
		SET SGN_RESULT = ${sgnResult}
		<if test='sgnComent != null and !sgnComent.equals("")'>
		    , SGN_COMENT = #{sgnComent}
		</if>
		    , SGN_DATE = SYSDATE
		WHERE DOC_NO = 1
		AND APPROVER_NO = ${approverNo}
	</update>
	<!-- 결재문서 상세조회 - 구매신청서 -->
	<select id="getDetailDocPurchaseOrder" resultMap="signDoc">
		SELECT
		    DOC.DOC_NO
		    , WRITER_NO
		    , TO_CHAR(INSERT_DATE, 'YYYY-MM-DD') INSERT_DATE
		    , DPO_NO
		    , ENAME
		    , DENAME
		    , ITEM_NAME
		    , BUY_CNT
		    , ITEM_PRICE
		    , BUY_DETAIL_NO
		    , BUY_DETAIL_PRICE
		    , BUY_PRICE
		    , DPO_COMMENT
		    , APPROVER_NO
		    , (SELECT ENAME FROM EMP WHERE EMPNO = SGN.APPROVER_NO) APPROVER_NAME
		    , (SELECT E_JOB FROM EMP WHERE EMPNO = SGN.APPROVER_NO) APPROVER_JOB
		    , SGN_ORDER
		    , DECODE(SGN_RESULT, '0', '미결재', '1', '결재') SGN_RESULT_STR
		    , SGN_COMENT
		    , TO_CHAR(SGN_DATE, 'YYYY-MM-DD')SGN_DATE
		    , BUY.BUY_NO
		FROM SGN_DOC DOC, DOC_PURCHASE_ORDER DPO, SGN, EMP, DEPT, BUY, BUY_DETAIL BD, ITEM
		WHERE DOC.DOC_NO = DPO.DOC_NO
		AND DOC.DOC_NO = SGN.DOC_NO
		AND DOC.WRITER_NO = EMP.EMPNO
		AND EMP.DEPTNO = DEPT.DEPTNO
		AND BUY.BUY_NO = DPO.BUY_NO
		AND BUY.BUY_NO = BD.BUY_NO
		AND BD.ITEM_NO = ITEM.ITEM_NO
		AND DOC.DOC_NO = ${docNo}
	</select>
	
	
	
	
	<select id="getItemList" resultMap="item">
		SELECT 
			ITEM_NO
			, ITEM_NAME
			, ITEM_PRICE
		FROM ITEM
		ORDER BY ITEM_NO
	</select>
	
	
	
	
</mapper>



























